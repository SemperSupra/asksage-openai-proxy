name: Approved PRs Only
on:
  pull_request_target:
    types: [opened, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  check-collaborator:
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is a collaborator
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;

            try {
              // Check if user is a collaborator
              await github.rest.repos.checkCollaborator({
                owner,
                repo,
                username,
              });
              console.log(`${username} is a collaborator.`);
            } catch (error) {
              // If 404, user is not a collaborator
              if (error.status === 404) {
                console.log(`${username} is NOT a collaborator.`);

                const labelName = 'unapproved';
                const commentBody = 'Thanks for the PR. This project is invite-only and only accepts PRs from approved collaborators.';

                // Ensure label exists (idempotent)
                try {
                  await github.rest.issues.getLabel({
                    owner,
                    repo,
                    name: labelName
                  });
                } catch (labelError) {
                  if (labelError.status === 404) {
                    console.log(`Creating label: ${labelName}`);
                    await github.rest.issues.createLabel({
                      owner,
                      repo,
                      name: labelName,
                      color: 'ff0000',
                      description: 'Issue/PR from non-collaborator'
                    });
                  }
                }

                // Add label to PR (PRs are issues for labeling)
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue_number,
                  labels: [labelName]
                });

                // Add comment to PR
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue_number,
                  body: commentBody
                });

                // Close PR
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: issue_number,
                  state: 'closed'
                });

              } else {
                // If other error, rethrow
                throw error;
              }
            }
